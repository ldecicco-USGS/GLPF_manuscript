---
title: "Results"
author: "Steven R. Corsi, Laura A. De Cicco, Angela Hanson, Peter Lenaker, Brian Bergamaschi, Brian Pellerin"
date: ""
#output: word_document
output:
  bookdown::word_document2:
#    css: environmental-science-and-technology.csl
    fig_caption: yes
    toc: no
    reference_docx: "word-styles-reference-orig.docx"
#bibliography: Optical properties.bib
#link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(root.dir = '../../') 
```


```{r read_sites, echo=FALSE}


model_summary <- readRDS("model/out/modeling_summary_table.rds")
model_summary$Bachuman <- sub("Turbidity_mean","Turb",model_summary$Bachuman)
model_summary$Bachuman <- sub("Turb","Turbidity",model_summary$Bachuman)
vars <- unique(unlist(strsplit(model_summary$Bachuman,split = "_")))
var_names <- c("Turbidity","F","T","M","N","A290","A295","T2","Turbidity")


font_size <- 4

```

# Methods

## Regression modeling

Regression modeling was used to explore relations between bacteria concentrations (response variables) and optical signals (explanatory variables). All available measures of bacteria were included in regression analysis for each of the watershed scales. In all cases, response variables were log base 10 transformed. From a practical standpoint for potential field application, explanatory variable selection for these regressions was done in two potential stages: First, optical signals that were already available as field sensors were considered (case 1). Next, explanatory variables were expanded to use of optical signals and variables that were derived from optical signals. Only those variables that were not correlated to the field sensor signals with a correlation coefficient of 0.95 or greater were considered. These signals included direct fluorescence or absorbance signals at specific wavelengths, means of fluorescence or absorbance signals over specified bandwidths, ratios of these signals, spectral slopes determined as the slope of the absorbance curve over specified wavelengths in exponential space (**<span custom-style="OrangeText">add reference here</span>**), and several optical indices that have been used in previous research (**<span custom-style="OrangeText">add references here</span>**). Given the potential for seasonality in dissolved organic matter composition in streams (@kaiser_seasonal_2001, @coble_temporal_2016), seasonal varaibles (sine and cosine of julian day/(2$\pi$)) were used to develop interaction terms with optical signals. Optical signals used as case 1 variables included signals F (commonly called fDOM or CDOM) and T (often referred to as tryptophan-like fluorescence) as well as turbidity. Final explanatory variables used in this analysis are presented in the supporting information (Table SI-xx).

The model selection process included several steps with the ultimate goal of minimizing error in prediction while choosing a model that has a reasonable fit for all sites in the data set. It was not uncommon to find a model that appeared to be a good fit overall but did not provide a good fit for data from one or more of the  individual sites. For this reason, exploration of potential regression models was conducted using data sets that included multiple sites as well as one single-site data set (Milwaukee River). The Milwaukee River was modeled independently from other sites because the nature of organic matter influence was substantially different than other sites: The moniotoring station at this site was near Lake Michigan and a seiche effect is commonly present, posing the potential for Lake Michigan water influence. In addition, sites with similar land cover were grouped into one data set (e.g. urban, agrucultural). For the single-site data set, ordinary least squares regression (OLS) was used. For data sets with more than one site included, linear heirarchical mixed effects models (LME) were used to account for potential shifts in the statistical relationships among sites (**<span custom-style="OrangeText">add references for base r and lme4</span>**). For both modeling techniques, 5-fold cross validation repeated 50 times was conducted to estimate predictive accuracy. The median root mean squared residuals (RMSE) for the 50 fits was used to compare among models with different explanatory variable combinations. For models that included only one site (Milwaukee River), the model with the lowest median sum of RMSE was chosen. For models that included multiple sites, model options within 3% of the of the lowest median sum of RMSE were evaluated further by considering the quality of fit for each individual site. The RMSE was computed individual sites, and the maximum and minimum individual site RMSE values for each model were identified. The final model was chosen based on the smallest difference between the maximum and minimum individual site RMSE. This minimized the chances of choosing a multiple-site model with a poor fit for individual sites. 

# Results {#results}

```{r,echo=FALSE}
library(tidyverse)
library(ggplot2)
library(scales)
library(cowplot)
library(flextable)
library(officer)

dfHM <- readRDS("process/out/combined_human_markers.rds")
occur <- function(x) mean(x>225)
dfHM_summary <- dfHM %>% 
  group_by(scale) %>%
  summarize(n = length(bacHum))
dfHM$hm <- dfHM$bacHum + dfHM$lachno2

maxHM <- round(max(dfHM$hm)/10^9,2)
maxSite <- dfHM[which.max(dfHM$hm),"site"]
maxScale <- dfHM[which.max(dfHM$hm),"scale"]

source(file = "plots/src/Figure_2.R")
source(file = "plots/src/Figure_3.R")
source(file = "plots/src/Figure_4.R")

ConcOccurrenceFig <- plot_fig_2()
bacteria_vs_virus <- plot_fig_3()
Prediction_vs_virus <- plot_fig_4()

```
Throughout the study, `r sum(dfHM_summary$n)` samples were collected, including `r dfHM_summary[1,"n"]` samples from `r dfHM_summary[1,"scale"]` scale sites, `r dfHM_summary[2,"n"]` samples from `r dfHM_summary[2,"scale"]` scale sites, and `r dfHM_summary[3,"n"]` samples from `r dfHM_summary[3,"scale"]` scale sites. The sum of the two human indicator bacteria markers (hereafter referred to as sHM) varied from below the reporting level to a maximum of `r maxHM` x 10^9^ cn/100 ml (Figure \@ref(fig:ConcAndOccurrenceFig)).



```{r ConcAndOccurrenceFig, dpi=300, fig.width=3,fig.height=5, fig.cap = "The sum of human indicator bacteria markers A. concentrations and B. Occurrence proportion in samples from small storm sewers and open channels (small scale), subwatersheds of the Milwaukee River (subwatershed scale), and tributaries of the Great Lakes (watershed scale). For each scale, sites are ordered by most to least urban land use percentage from left to right. Number of observations in each concentration bin are profided above the bars.", echo=FALSE}

print(ConcOccurrenceFig)

```


``` {r, echo = FALSE}
# Determine several parameters to help describe the results
#1. Differences within the small scale
dfSmall <- dfHM %>% filter(scale=="small")
WI_ratio <- round(mean(dfSmall[which(dfSmall$site=="WI"),"hm"])/mean(dfSmall[which(dfSmall$site!="WI"),"hm"]),0)
WI_ratio_median <- round(median(dfSmall[which(dfSmall$site=="WI"),"hm"])/median(dfSmall[which(dfSmall$site!="WI"),"hm"]),0)
#confirmed p< 0.05
wilcox.result <- wilcox.test(dfSmall[which(dfSmall$site=="WI"),"hm"],dfSmall[which(dfSmall$site!="WI"),"hm"]) 
hmMINYEvent <- dfSmall[which(dfSmall$site!="WI" & dfSmall$hydro_cond=="Event"),"hm"]
hmMINYLowflow <- dfSmall[which(dfSmall$site!="WI" & dfSmall$hydro_cond!="Event"),"hm"]
wilcox.result2 <- wilcox.test(hmMINYEvent,hmMINYLowflow)

#See explor_hb_concentrations for tests of event vs low flow for subwatershed scale and watershed scale
#for sites with > 25% urban vs sites with < 25% urban

```


There were differences in sHM concentrations among sites and by hydrologic condition (Figure \@ref(fig:ConcAndOccurrenceFig)). At small-scale sites, median concentrations of sHM were `r WI_ratio_median` times greater in samples from the Wisconsin sites than those from the other states (p < 0.05). In samples from Michigan and New York, results indicated greater sHM concentrations during runoff events than during periods of low flow (p < 0.05), but results from the small scale sites in Wisconsin indicated no significant difference in sHM concentrations by hydrologic event. 

Samples collected at sites with greater than 25% urban land cover at the watershed and subwatershed scales had greater sHM concentrations during runoff event periods than low-flow periods (p<0.05). Concentrations of sHM at sites with less than 25% urban land cover at these two scales did not vary significantly by hydrologic condition. 

Human viruses were analyzed for a subset of XX samples from the watershed and YY samples from subwatershed-scale sites concurrently with the human-associated and the general indicator bacteria, providing a means to assess potential exposure to human pathogens from sampled water. The fraction of samples for which human viruses were present increased with increasing sHM concentration, but the two fecal indicator bacteria, E. coli and enterococci, did not have an apparent relationship with human virus occurrence (Figure \@ref(fig:VirusOccurrenceFig)). These results reinforce the the assumption that human-associated bacteria markers represent presence of sewage and an increased risk of exposure to human pathogens with increasing human-associated bacteria concentrations. Occurrence of human viruses did not increase with increasing concentration of the non-specific fecal indicators E. coli and enterococci. 

```{r VirusOccurrenceFig, dpi=300, fig.width=3,fig.height=5, fig.cap = "Fraction of human virus occurrence as compared to concentration bins for A. the sum of human associated bacteria, B. Escherichia coli, and C. Enterococci in samples from subwatersheds of the Milwaukee River (subwatershed scale), and tributaries of the Great Lakes (watershed scale). Number of observations in each concentration bin are profided above the bars. sHM concentration of 450 Copy Number/100mL represents the analytical detection level. E. coli concentration of 235 CFU/100mL represents a common recreational water quality criteria.", echo=FALSE}

print(bacteria_vs_virus)

```

  + Bin sHM into the same categories as GLRI Phase I report
    + Graph virus %occurrence vs sHM bins
    + Is there a stats technique to do this? Categorical logistic regression?
       + test

## Regression Modeling
Regression models were explored for description of the variability of human-associated bacteria using optical signals. The first consideration in regression modeling was the choice of sites to include in common models. Watershed and subwatershed sites were initially grouped together for a unified model. These efforts resulted in poor cross-validated predictive capability, and no adequate models were discovered. Next, categories from watershed and subwatershed sites were chosen for similarity in land cover and potential diversity of water quality influences as well as geographic proximity. These groups were chosen to minimize differences in background DOC that could lead to confounding signals in regressions, resulting in four site categories: Watershed-scale sites were separated into three categories for model development including Agricultural (Maumee, Portage, and Raisin), Urban (Clinton and Rouge), and single site (Milwaukee), and the three subwatershed-scale sites were included as the fourth category. Separating sites into these four categories resulted in improved cross-validated predictive capability for resulting models over the watershed- and subwatershed-scale unified model, so the four categories were selected for inclusion in final model development (Table \@ref(tab:tabTest)). 

Model development attempts for the small-scale sites also included four data groupings: first, data from all sites and samples within the three regions was used to develop one unified model, and second, separate data sets from each of the three regions was used to develop individual models. Resulting models for small-scale sites were all considered to be inadequate for the intended purpose: To meet sensor development needs for tracing contamination back to the source, regressions must provide increasing predictions with increasing human bacteria concentrations for individual events within a storm sewer system or small drainage basin. Attempts to develop models for the small-scale sites did not result in models that consistently met this need.

Table \@ref(tab:tabTest) using table 1 function.

```{r tabTest, echo= FALSE}
source("./Report/Tables/Table1.R")
table_1 <- make_table_1(model_summary)
table_1 <- set_caption(table_1, "Table: (\\#tab:tabTest)")
table_1
```

-Mention seasonal interaction terms
-Mention site terms in LMER routine
-Sensors vs non-cor

Models were developed with two sets of optical variables: First, using optical signals to represent those used in commercially available field sensors (sensor models), and second, using additional optical signals that were not highly correlated with at least one of the sensor signals (non-correlated models). Two important attributes of the selected models included interaction of the optical variables with a seasonal term, and, for multi-site models, use of individual sites as random effects in the mixed effect models. The seasonal term helped account for variable DOC presence as vegetation cover changed throughout the year and as soil contact of runoff varied with snow cover. The inclusion of individual sites as random effects can help control for variable background DOC in watersheds resulting from different geologic environments and land cover. Preliminary model exploration verified that inclusion of these two model attributes resulted in improved model fit. 

The sensor models included different combinations of "T" (often referred to as tryptophan-like fluorescence), "F" (often referred to as "CDOM" or "fDOM"), and turbidity. T and F were commonly included in final models as interaction terms with seasonality. All final sensor models included turbidity, indicating that turbidity may be the most valuable signal for inclusion in these surrogate models with additional optical signals and seasonal terms to enhance accuracy of theses models. 

There was not a consistent substantial improvement in cross-validation error (root mean squared error, RMSE)  from inclusion of non-correlated signals compared to models developed using the sensor signals (Table \@ref(tab:tabTest)). The enterococci culture models for the urban large watershed sites and for the Milwaukee River site were the only two models that had 10% or greater decrease in RMSE by using models developed with the non-correlated signal variables. Variables in the non-correlated models included two fluorescence signals (M and N), ratios of fluorescence signals, the fluorescence index, and ratios of absorbance signals. Collectively, results suggest that there may be minor improvements in model performance by use of the non-correlated signal variables for a few selected site-organism combinations, but that the optical signals selected for these models are not consistent.

The proportion of virus occurrence increased with the sum of fitted sHB (sensor models). For instances when fitted model values were below 1000 copy number/100mL, no viruses were detected. Virus detection increased with increasing concentration up to 40% virus detection when sHB fitted values were greater than 100000 copy number/100mL. Because human viruses were measured independently from human bacteria and not used in model development, this result provides independent verification that the sensor models have the capability of predicting the presence of sewage and potential risk from human pathogens (Figure\@ref(fig:PredictionToVirusFig)). 


```{r PredictionToVirusFig, dpi=300, fig.width=3,fig.height=2, fig.cap = "Fraction of human virus occurrence as compared to concentration bins for the sum of human associated bacteria computed from fitted values from regression models developed using laboratory-measured optical signals that represent currently available optical sensors. Number of observations in each concentration bin are profided above the bars. sHM concentration of 450 Copy Number/100mL represents the analytical detection level.", echo=FALSE}

print(Prediction_vs_virus)

```




<div custom-style="RedText">Whole paragraph of colored text</div>

**Describe the way models were chosen**

  - ~~minimizing the median cross validated sum of squared errors~~
  - ~~examining each model for reasonable description of variability for all sites included. At times there were reasonable regressions overall, but one or more sites did not fit well. These models were not chosen.~~
  + Groupings of sites
    + All sites
    + Elimination of JI (seiche)
    + Groupings of like sites 
    + Urban
    + Ag
    + JI only
        + test
    + Only sites with at least 15 detections



### Selected models

Describe models selected
 + Two models were selected for each organism/site grouping combo
 + sensor variables = F, T, Turbidity + seasonality + mixed effect with sites
 + Same variables for all response variables
 + additional signals did not improve regressions over sensor signals
 
Two models were selected for each 

Regression modeling for watershed and subwatershed sites resulted in among all of the 



# Actions needed:
1. Develop site characteristics table. Land cover for the watershed and subwatershed scales, and for the three primary small watersheds in the small scale.
    + need site IDs for middle branch Clinton and Red Creek, NY
2. Use these characteristics to describe the hydrologic changes. Urban: hydro change, non-urban no hydro change.

3. (DONE?) Run MDL scripts on all three data sets

4. (DONE) Run optical summary scripts for all three data sets

5. Combine the three data sets into one with scale variable for subsetting.




Points to make with this figure:

1. Small scale
    +Wisconsin small scale had samples with max concentrations and were generally higher than other sites
2. Medium scale
    + difference in event vs low flow for more urban sites.
3. Many sites had greater concentrations during runoff events. This is true for the watersheds and subwatersheds that had substantial urban influence. 
    + Look into urban influence vs ratio of event to low flow?
4. Seasonality? 
    + Reference GLRI report?
 
Do we want a similar descriptive set of graphs for some of the optical properties? maybe for SI?

1. ordered list
2. item 2
    + sub-item 1
    + sub-item 2 
    

Modeling points to make:

1. MMSD: 
  a. There were three CSO events. All three of these are outliers in the model. The model underpredicts these values for all bacteria modeled. Adding a CSO term aligns these with the rest of the model (adjustment of the intercept), but three observations is not enough to provide confidence in that model term. Additional CSO event samples would be needed to provide sufficient confidence in these results.


#Discussion

**General sHM presence**



**Virus relation to sHM and no relation to FIB**
verifying that sHM, a measure of sewage contamination, does have a connection to the presence of waterborne pathogens . There were no apparent relation

 Human viruses are present in sewage only when they are present in the population, so the relation between human viruses and human-associated bacteria is expected to vary with human virus presence in the population. Even so, presence of human viruses are more likely to be present when 



**Modeling**
A primary objective of the project was to develop regressions between optical signals and human-associated bacteria for potential extension to optical field sensors.

Site selection for model development was designed to provide the best chance of a consistent relation between dissoved organic carbon (DOC) characterization and sewage contamination. The Maumee River, Portage River, and River Raisin are agricultural tributaries of Western Lake Erie, The Clinton River and River Rouge are watersheds with a high degree of urban influence within the Lake St. Claire-Detroit River corridor, the Milwaukee River was sampled in an area with a regular seiche effect that includes transitional influences from the Milwaukee River and Lake Michigan, and the subwatershed sites are at different locations within the same watershed. 


 IMPORTANT TO INCLUDE HERE: The gain in accuracy may not warrant development of multiple additional sensors for only a small gain in accuracy. 
 
#References

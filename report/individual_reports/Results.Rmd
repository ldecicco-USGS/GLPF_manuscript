---
title: "Results"
author: "Steven R. Corsi, Laura A. De Cicco and others"
date: "November 30, 2018"
#output: word_document
output:
  bookdown::word_document2:
#    css: environmental-science-and-technology.csl
    fig_caption: yes
    toc: no
    reference_docx: "word-styles-reference-orig.docx"
#bibliography: Optical properties.bib
#link-citations: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
knitr::opts_knit$set(root.dir = '../../') 
```


```{r read_sites, echo=FALSE}


model_summary <- readRDS("model/out/modeling_summary_table.rds")

font_size <- 4

```

# Methods

## Regression modeling

Regression modeling was used to explore relations between bacteria concentrations (response variables) and optical signals (explanatory variables). All available measures of bacteria were included in regression analysis for each of the watershed scales. In all cases, response variables were log base 10 transformed. From a practical standpoint for potential field application, explanatory variable selection for these regressions was done in two potential stages: First, optical signals that were already available as field sensors were considered (case 1). Next, explanatory variables were expanded to use of optical signals and variables that derived from optical signals. Only those variables that not correlated to the field sensor signals with a correlation coefficient of 0.95 or greater were considered. These signals included direct fluorescence or absorbance signals at specific wavelengths, means of fluorescence or absorbance signals over specified bandwidths, ratios of these signals, spectral slopes determined as the slope of the absorbance curve over specified wavelengths in exponential space (**<span custom-style="OrangeText">add reference here</span>**), and several optical indices that have been used in previous research (**<span custom-style="OrangeText">add references here</span>**). Given the potential for seasonality in dissolved organic matter composition in streams (@kaiser_seasonal_2001, @coble_temporal_2016), seasonal varaibles (sine and cosine of julian day/(2$\pi$)) along with optical signals were used to develop interaction terms. Optical signals used as case 1 variables included signals F (commonly called fDOM or CDOM) and T (often referred to as tryptophan-like fluorescence) as well as turbidity. Final explanatory variables used in this analysis are presented in the supporting information (Table SI-xx).

The model selection process included several steps with the ultimate goal of minimizing error in prediction while choosing a model that has a reasonable fit for all sites in the data set. It was not uncommon to find a model that appeared to be a good fit overall but did not provide a good fit for data from one or more of the  individual sites. For this reason, exploration of potential regression models was conducted using data sets that included multiple sites as well as one single-site data set (Milwaukee River). The Milwaukee River was modeled independently from other sites because the nature of organic matter influence was substantially different than other sites: The moniotoring station at this site was near Lake Michigan and a seiche effect is commonly present, posing the potential for Lake Michigan water influence. In addition, sites with similar land cover were grouped into one data set (e.g. urban, agrucultural). For the single-site data set, ordinary least squares regression (OLS) was used. For data sets with more than one site included, linear heirarchical mixed effects models (LME) were used to account for potential shifts in the statistical relationships among sites (**<span custom-style="OrangeText">add references for base r and lme4</span>**). For both modeling techniques, 5-fold cross validation repeated 50 times was conducted to estimate predictive accuracy. The median root mean squared residuals (RMSE) for the 50 fits was used to compare among models with different explanatory variable combinations. For models that included only one site (Milwaukee River), the model with the lowest median sum of RMSE was chosen. For models that included multiple sites, model options within 3% of the of the lowest median sum of RMSE were evaluated further by considering the quality of fit for each individual site. The RMSE was computed individual sites, and the maximum and minimum individual site RMSE values for each model were identified. The final model was chosen based on the smallest difference between the maximum and minimum individual site RMSE. This minimized the chances that a multiple-site model with an individual site that has a poor fit would be chosen. 


# Results {#results}

```{r,echo=FALSE}
library(tidyverse)
library(ggplot2)
library(scales)
library(cowplot)
library(flextable)
library(officer)

dfHM <- readRDS("process/out/combined_human_markers.rds")
occur <- function(x) mean(x>225)
dfHM_summary <- dfHM %>% 
  group_by(scale) %>%
  summarize(n = length(bacHum))
dfHM$hm <- dfHM$bacHum + dfHM$lachno2

maxHM <- round(max(dfHM$hm)/10^9,2)
maxSite <- dfHM[which.max(dfHM$hm),"site"]
maxScale <- dfHM[which.max(dfHM$hm),"scale"]

```
Throughout the study, `r sum(dfHM_summary$n)` samples were collected, including `r dfHM_summary[1,"n"]` samples from `r dfHM_summary[1,"scale"]` scale sites, `r dfHM_summary[2,"n"]` samples from `r dfHM_summary[2,"scale"]` scale sites, and `r dfHM_summary[3,"n"]` samples from `r dfHM_summary[3,"scale"]` scale sites. The sum of the two human indicator bacteria markers (hereafter referred to as sHM) varied from below the reporting level to a maximum of `r maxHM` x 10^9^ cn/100 ml (Figure \@ref(fig:ConcAndOccurrenceFig)).



```{r ConcAndOccurrenceFig, fig.width=5,fig.height=5, fig.cap = "The sum of human indicator bacteria markers A. concentrations and B. Occurrence proportion in samples from small storm sewers and open channels (small scale), subwatersheds of the Milwaukee River (subwatershed scale), and tributaries of the Great Lakes (watershed scale). For each scale, sites are ordered by most to least urban land use percentage from left to right.", echo=FALSE}

source(file = "plots/src/Figure_2.R")

ConcOccurrenceFig <- plot_fig_2()
print(ConcOccurrenceFig)

```


``` {r, echo = FALSE}
# Determine several parameters to help describe the results
#1. Differences within the small scale
dfSmall <- dfHM %>% filter(scale=="small")
WI_ratio <- round(mean(dfSmall[which(dfSmall$site=="WI"),"hm"])/mean(dfSmall[which(dfSmall$site!="WI"),"hm"]),0)
WI_ratio_median <- round(median(dfSmall[which(dfSmall$site=="WI"),"hm"])/median(dfSmall[which(dfSmall$site!="WI"),"hm"]),0)
#confirmed p< 0.05
wilcox.result <- wilcox.test(dfSmall[which(dfSmall$site=="WI"),"hm"],dfSmall[which(dfSmall$site!="WI"),"hm"]) 
hmMINYEvent <- dfSmall[which(dfSmall$site!="WI" & dfSmall$hydro_cond=="Event"),"hm"]
hmMINYLowflow <- dfSmall[which(dfSmall$site!="WI" & dfSmall$hydro_cond!="Event"),"hm"]
wilcox.result2 <- wilcox.test(hmMINYEvent,hmMINYLowflow)

#See explor_hb_concentrations for tests of event vs low flow for subwatershed scale and watershed scale
#for sites with > 25% urban vs sites with < 25% urban

```


There were differences in sHM concentrations among sites and by hydrologic condition (Figure \@ref(fig:ConcAndOccurrenceFig)). At the small scale, median concentrations of sHM were `r WI_ratio_median` times greater at the Wisconsin sites than those from the other states (p < 0.05). In samples from Michigan and New York, results indicated greater sHM concentrations during runoff events than during periods of low flow (p < 0.05), but results from the small scale Wisconsin sites indicated no significant difference in sHM concentrations by hydrologic event. 

Samples collected at sites with greater than 25% urban land cover at the watershed and subwatershed scales had greater sHM concentrations during runoff event periods than low-flow periods (p<0.05). Concentrations of sHM at sites with less than 25% urban land cover at these two scales did not vary significantly by hydrologic condition. 

## Regression Modeling

Watershed sites were grouped into Agricultural (Maumee, Portage, and Raisin), Urban (Clinton and Rouge), and a single site (Milwaukee), and the three subwatershed sites were grouped together for model development for model development (Table \@ref(tab:tabTest)). 

Table \@ref(tab:tabTest) provided the results first.
Table \@ref(tab:tabTest) provided the results second


```{r tabTest, echo= FALSE}
source("./Report/Tables/Table1.R")
table_1 <- make_table_1(model_summary)
table_1
```




Table \@ref(tab:tabTest1) provided the results second

```{r tabTest1, echo= FALSE}
  model_summary$Sites <- c("Watershed: Agriculture", "Watershed: Agriculture", 
                           "Watershed: Urban", "Watershed: Urban", "Milwaukee River", 
                           "Milwaukee River", "Subwatersheds", "Subwatersheds")
  names(model_summary) <- make.names(names(model_summary))
  
  Header1 <- c("", "", "Human Bacteroides", "Human Bacteroides", 
               "Lachnospiraceae", "Lachnospiraceae", 
               "Enterococci","Enterococci", 
               "Enterococci Culture", "Enterococci Culture", 
               "E. coli", "E. coli")
  
  Header2 <- c("Sites", "Category", rep(c("Variables","RMSE"),5))
  Type <- c(rep("character",2),rep(c("character","numeric"),5))
  
  header_df <- data.frame(col.keys = names(model_summary),
                          #type = Type,
                          what = Header1,
                          measure = Header2,
                          stringsAsFactors = FALSE)
  
  
  #names(model_summary) <- header2
  table1 <- flextable(model_summary, cwidth = 0.7)
  table1 <- fontsize(table1, size = 7)
  table1 <- width(table1, width = 0.5, j = grep("RMSE", names(model_summary)))
  table1 <- set_header_df(table1,mapping=header_df, key = names(header_df)[1])
  table1 <- height(table1, height = 0.3,
                   part = "header")
  table1 <- fontsize(table1, size = 8, part = "header")
  
  table1 <- align(table1,align="center",part = "all")
  table1 <- align(table1,j=c(1,2,3,5,7,9,11),align="left",part = "all")
  table1 <- align(table1,j=1,align="left")
  table1 <- border_outer(table1, border = NULL, part = "all")
  table1 <- hline(table1,i = 2, part = "header",border=fp_border(color="black",width=2)  )
  table1 <- hline_top(table1,part = "header",border=fp_border(color="black",width = 2)  ) 
  table1 <-merge_v(table1,j=~Sites) 
  table1 <-merge_h(table1,i=1,part="header") 
  table1 <- align(table1,i=1,align="center",part="header")
  table1
```


  




<div custom-style="RedText">Whole paragraph of colored text</div>

**Describe the way models were chosen**

  - ~~minimizing the median cross validated sum of squared errors~~
  - ~~examining each model for reasonable description of variability for all sites included. At times there were reasonable regressions overall, but one or more sites did not fit well. These models were not chosen.~~
  + Groupings of sites
    + All sites
    + Elimination of JI (seiche)
    + Groupings of like sites 
    + Urban
    + Ag
    + JI only
        + test
    + Only sites with at least 15 detections



### Selected models

Describe models selected
 + Groupings of sites
 + primary variables = F, T, Turbidity + seasonality + mixed effect with sites
 + Same variables for all response variables
 + Report median sum of squared residuals?
 
Regression modeling for watershed and subwatershed sites resulted in among all of the 



# Actions needed:
1. Develop site characteristics table. Land cover for the watershed and subwatershed scales, and for the three primary small watersheds in the small scale.
    + need site IDs for middle branch Clinton and Red Creek, NY
2. Use these characteristics to describe the hydrologic changes. Urban: hydro change, non-urban no hydro change.

3. (DONE?) Run MDL scripts on all three data sets

4. (DONE) Run optical summary scripts for all three data sets

5. Combine the three data sets into one with scale variable for subsetting.




Points to make with this figure:

1. Small scale
    +Wisconsin small scale had samples with max concentrations and were generally higher than other sites
2. Medium scale
    + difference in event vs low flow for more urban sites.
3. Many sites had greater concentrations during runoff events. This is true for the watersheds and subwatersheds that had substantial urban influence. 
    + Look into urban influence vs ratio of event to low flow?
4. Seasonality? 
    + Reference GLRI report?
 
Do we want a similar descriptive set of graphs for some of the optical properties? maybe for SI?

1. ordered list
2. item 2
    + sub-item 1
    + sub-item 2 
    

Modeling points to make:

1. MMSD: 
  a. There were three CSO events. All three of these are outliers in the model. The model underpredicts these values for all bacteria modeled. Adding a CSO term aligns these with the rest of the model (adjustment of the intercept), but three observations is not enough to provide confidence in that model term. Additional CSO event samples would be needed to provide sufficient confidence in these results.


#References
